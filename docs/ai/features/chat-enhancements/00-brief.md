# Support Chat Enhancements — Brief

## Feature slug
`chat-enhancements`

---

## Контекст

Фича `support-chat` уже реализована и включает:

- двусторонний чат пользователь ↔ поддержка  
- realtime через SSE  
- вложения  
- Telegram-уведомления при новом сообщении пользователя  
- индикатор прочитано  

Новая задача — расширение существующего функционала без изменения базовой архитектуры.

---

## Цель

1. Отображать бейдж с общим числом **неотвеченных сообщений** в sidebar на разделе “чат поддержки”.
2. Отображать бейдж индикатор  **неотвеченное сообщений** в окне диалогов на конкретном диалоге в виде оранжевого кружка.
3. Добавить возможность **редактировать или удалять своё сообщение**, если оно **не было прочитано** другой стороной.
4. Изменить UI для админ-панели. На десктопе и таблетах при клике на "support чат" открывается страница с колонкой диалогов, вверху отображаются со статусом "не отвеченные", если много диалогов, то можно скролить вниз. Скролл должен быть оптимизирован и догружать данные по мере прокрутки. 
При клике на диалог открывается соответствующий чат рядом. Если ширина экрана не позволяет, то открывается чат и сверху есть кнопка "назад", которая возвращает к списку диалогов.
---

## Где

### Sidebar
- Поддержка: админ-панель  

### Профиль пользователя
- Пользователь: личный кабинет. 
- Бейдж с уведомлением, если есть не прочитанное сообщение в виде оранжевого круга.

Бейдж отображается в правом верхнем углу “чат поддержки”.

### Диалог
- Страница конкретного диалога  
- UI как в Telegram  

---

## Новые функциональные требования

### 1. Badge “неотвеченные”

#### 1.1 Что отображается
- Число диалогов, требующих ответа.
- Бейдж отображается только если значение > 0.

#### 1.2 Для пользователя
Диалог считается “неотвеченным”, если:
- последнее сообщение в диалоге отправлено поддержкой
- и оно не прочитано пользователем

#### 1.3 Для поддержки
Диалог считается “неотвеченным”, если:
- последнее сообщение отправлено пользователем
- и оно не прочитано поддержкой

#### 1.4 Realtime
- Бейдж обновляется через SSE.
- При получении нового сообщения или изменении read-state происходит обновление.

---

### 2. Редактирование сообщения

#### 2.1 Кто может редактировать
- Автор сообщения (user или staff)

#### 2.2 Ограничение
- Сообщение можно редактировать **только если оно не было прочитано другой стороной**.

#### 2.3 Что происходит при редактировании
- Обновляется текст сообщения
- Фиксируется поле `editedAt`
- В UI отображается индикатор тоаст “(изменено)”

#### 2.4 Ограничения
- Нельзя изменить автора
- Нельзя изменить тип отправителя
- Повторная серверная валидация (zod)
- Ограничения по длине текста сохраняются

---

### 3. Удаление сообщения

#### 3.1 Кто может удалить
- Автор сообщения
- Только если сообщение не было прочитано другой стороной

#### 3.2 Поведение
- Сообщение не удаляется физически из БД
- Используется soft-delete:
  - `deletedAt`
  - `deletedBy`

#### 3.3 Отображение
- В UI показывается: “Сообщение удалено”
- История диалога сохраняется

#### 3.4 Вложения
- Вложения не удаляются из storage немедленно
- Очистка orphan-объектов выполняется существующей стратегией проекта

---

## Нефункциональные требования

### Security
- Проверка ownership на уровне сервиса
- Нельзя редактировать или удалять чужое сообщение
- Нельзя обойти ограничение “не прочитано”
- Защита от IDOR
- Серверная проверка read-state

### Производительность
- Обновление бейджа не должно приводить к полной перезагрузке sidebar
- Использовать существующую стратегию React Query + targeted invalidation

### UX
- Кнопки “Редактировать” и “Удалить”:
  - отображаются в всплывающем меню при клике на сообщение, на мобильных устройствах при одинарном табе
  - доступны только для своих сообщений
  - доступны только если сообщение ещё не прочитано
- При попытке действия после прочтения — корректная ошибка

---

Все процедуры:
- protected
- с обязательной проверкой ownership
- с проверкой read-state до выполнения операции

---
