// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum ROLE {
  ADMIN
  STAFF
  USER
}

enum BlockType {
  text
}

enum AccessType {
  free
  paid
}

enum WorkoutDifficulty {
  EASY
  MEDIUM
  HARD
}

enum MealCategory {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
  SALAD
  DESSERT
  SOUP
}

enum RecipeDifficulty {
  EASY
  MEDIUM
  HARD
}

enum WorkoutSection {
  STRENGTH // Силовые
  CORRECTION // Коррекция осанки
  FUNCTIONAL // Функциональные
  WARMUP // Зарядки
  PAIN // Решает боль
}

enum WorkoutSubsection {
  UPPER_BODY // Верхняя часть
  LOWER_BODY // Нижняя часть
  FULL_BODY // Все тело
  SPINE // Позвоночник
  JOINT // Суставы
  ANTI_EDEMA // От отеков
  ANTI_TENSION // От зажимов
  PELVIC_FLOOR // Мышцы тазового дна
  STRETCHING // Растяжка
  INERTIAL // Инерционные
  NECK // Шея
  BACK // Спина
  FEET // Стопы
  ABDOMEN // Живот
  PELVIS_SPINE // Таз + позвоночник
  BREATHING // Дыхание
  ENERGY_BOOST // Зарядись энергией
  PILATES // Силовой пилатес
  PELVIC_HIP_JOINT // тбс
}

enum DailyContentType {
  WARMUP
  MAIN
}

enum CourseContentType {
  FIXED_COURSE // Фиксированный курс
  SUBSCRIPTION // Курс для подписки
}

enum MuscleGroup {
  LEGS
  GLUTES
  UPPER_BODY
  BACK
  PELVIC_FLOOR
  CORE
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum PaymentState {
  pending
  success
  failed
}

enum UserAccessReason {
  paid
  free
  manual
}

model Course {
  id                        String            @id @default(cuid())
  slug                      String            @unique
  title                     String
  description               String
  shortDescription          String?
  thumbnail                 String
  image                     String
  draft                     Boolean
  durationWeeks             Int
  allowedWorkoutDaysPerWeek Int[]             @default([])
  contentType               CourseContentType @default(FIXED_COURSE)
  product                   CourseProduct?

  dailyPlans DailyPlan[] // Дни (планы) в фиксированном курсе
  weeks      Week[] // Недели для подписочных курсов

  enrollments UserCourseEnrollment[]
  mealPlans   MealPlan[]

  dependencies CourseDependency[] @relation("CourseDependencies")
  dependents   CourseDependency[] @relation("CourseDependents")

  knowledgeCategories CourseKnowledgeCategory[]
}

model KnowledgeCategory {
  id          String @id @default(cuid())
  slug        String @unique
  title       String
  description String?

  articles KnowledgeArticle[]
  courses  CourseKnowledgeCategory[]
}

model CourseKnowledgeCategory {
  courseId   String
  categoryId String
  order      Int    @default(0)

  course   Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  category KnowledgeCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([courseId, categoryId])
  @@index([courseId])
  @@index([categoryId])
}

model KnowledgeArticle {
  id          String @id @default(cuid())
  title       String
  description String?
  content     String? // Rich text content if needed
  videoId     String? // Kinescope ID
  attachments Json? // Array of { name: string, url: string }
  order       Int     @default(0)

  categoryId String
  category   KnowledgeCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
}

model UserCourseEnrollment {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  courseId String
  course   Course @relation(fields: [courseId], references: [id])

  selectedWorkoutDays DayOfWeek[]
  startDate           DateTime

  hasFeedback Boolean @default(false) // Куплена ли версия с обратной связью

  userDailyPlans     UserDailyPlan[] // Связь с ежедневными планами пользователя
  workoutCompletions UserWorkoutCompletion[]
  active             Boolean                 @default(false) // Активен ли курс для пользователя
  userAccesses       UserAccess[]            @relation("EnrollmentUserAccess")

  @@index([userId, startDate])
}

model Week {
  id         String      @id @default(cuid())
  weekNumber Int
  releaseAt  DateTime
  courseId   String
  course     Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  dailyPlans DailyPlan[]
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  @@unique([courseId, weekNumber])
  @@map("weeks")
}

model DailyPlan {
  id              String         @id @default(cuid())
  slug            String // Например, "week-1-day-1"
  dayNumberInWeek Int // 1-7
  weekNumber      Int
  description     String?
  contentBlocks   ContentBlock[] // Если нужны дополнительные текстовые блоки в дне
  mainWorkouts    DailyPlanMainWorkout[]

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  // Для подписочных курсов - связь с неделей
  weekId String?
  week   Week?   @relation(fields: [weekId], references: [id], onDelete: Cascade)

  warmupId String?
  warmup   Workout? @relation("WarmupDailyPlan", fields: [warmupId], references: [id])

  mealPlanId String?
  mealPlan   MealPlan? @relation(fields: [mealPlanId], references: [id], onDelete: SetNull)

  userDailyPlans UserDailyPlan[] @relation("OriginalDailyPlan")

  @@unique([courseId, slug])
  @@unique([courseId, weekNumber, dayNumberInWeek])
}

model DailyPlanMainWorkout {
  id          String    @id @default(cuid())
  dailyPlanId String
  workoutId   String
  order       Int       // Позиция основной тренировки в дне (0,1,2...)

  dailyPlan DailyPlan @relation(fields: [dailyPlanId], references: [id], onDelete: Cascade)
  workout   Workout   @relation("WorkoutDailyPlanMainWorkouts", fields: [workoutId], references: [id])

  @@unique([dailyPlanId, order])
  @@index([workoutId])
}

model UserDailyPlan {
  id                   String               @id @default(cuid())
  userId               String
  enrollmentId         String
  date                 DateTime
  dayNumberInCourse    Int
  isWorkoutDay         Boolean
  warmupId             String
  mealPlanId           String?
  dayOfWeek            DayOfWeek
  weekNumber           Int
  warmupStepIndex      Int
  enrollment           UserCourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  mealPlan             MealPlan?            @relation("UserDailyMealPlan", fields: [mealPlanId], references: [id], onDelete: SetNull)
  user                 User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  warmup               Workout              @relation("UserDailyWarmup", fields: [warmupId], references: [id])
  originalDailyPlanId  String
  originalDailyPlan    DailyPlan            @relation("OriginalDailyPlan", fields: [originalDailyPlanId], references: [id])
  mainWorkouts         UserDailyMainWorkout[]

  @@unique([enrollmentId, dayNumberInCourse]) // Один план на день для каждого enrollment
  @@index([enrollmentId])
  @@index([userId, date])
}

model UserDailyMainWorkout {
  id              String         @id @default(cuid())
  userDailyPlanId String
  workoutId       String
  order           Int            // Позиция основной тренировки в дне (0,1,2...)
  stepIndex       Int            // Соответствующий шаг прогресса

  userDailyPlan UserDailyPlan @relation(fields: [userDailyPlanId], references: [id], onDelete: Cascade)
  workout       Workout       @relation("WorkoutUserDailyMainWorkouts", fields: [workoutId], references: [id])

  @@unique([userDailyPlanId, order])
  @@index([userDailyPlanId])
  @@index([workoutId])
}

model Workout {
  id                    String              @id @default(cuid())
  title                 String
  difficulty            WorkoutDifficulty
  equipment             String[]
  description           String?
  videoId               String?
  muscles               MuscleGroup[]
  section               WorkoutSection
  subsections           WorkoutSubsection[]
  mainPlanWorkouts      DailyPlanMainWorkout[] @relation("WorkoutDailyPlanMainWorkouts")
  warmupDailyPlans      DailyPlan[]         @relation("WarmupDailyPlan")

  userDailyMainWorkouts UserDailyMainWorkout[] @relation("WorkoutUserDailyMainWorkouts")
  userDailyWarmups      UserDailyPlan[]         @relation("UserDailyWarmup")
  favoriteWorkouts      UserFavoriteWorkout[]
  userCompletions       UserWorkoutCompletion[]

  // Kinescope metadata
  durationSec Int     @default(0)
  poster      Json?
  posterUrl   String?
  progress    Int?
  needsReview     Boolean   @default(true)
  manuallyEdited  Boolean   @default(false)
  lastSyncedAt    DateTime?
}

model UserWorkoutCompletion {
  id           String               @id @default(cuid())
  userId       String
  workoutId    String
  enrollmentId String
  completedAt  DateTime             @default(now())
  contentType  DailyContentType
  stepIndex    Int
  enrollment   UserCourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  workout      Workout              @relation(fields: [workoutId], references: [id])

  @@unique([userId, enrollmentId, contentType, workoutId, stepIndex])
  @@index([userId])
  @@index([enrollmentId])
  @@index([workoutId])
}

model MealPlan {
  id                String          @id @default(cuid())
  title             String
  description       String?
  breakfastRecipeId String
  courseId          String
  dinnerRecipeId    String
  lunchRecipeId     String
  slug              String
  dailyPlans        DailyPlan[]
  breakfastRecipe   Recipe          @relation("BreakfastMeal", fields: [breakfastRecipeId], references: [id])
  course            Course          @relation(fields: [courseId], references: [id], onDelete: Cascade)
  dinnerRecipe      Recipe          @relation("DinnerMeal", fields: [dinnerRecipeId], references: [id])
  lunchRecipe       Recipe          @relation("LunchMeal", fields: [lunchRecipeId], references: [id])
  userDailyPlans    UserDailyPlan[] @relation("UserDailyMealPlan")

  @@unique([courseId, slug])
  @@index([courseId])
}

model Recipe {
  id                     String               @id @default(cuid())
  title                  String
  description            String?
  preparationTimeMinutes Int
  calories               Int?
  servings               Int
  difficulty             RecipeDifficulty
  isGlutenFree           Boolean              @default(false)
  isSugarFree            Boolean              @default(false)
  mealCategories         MealCategory[]
  slug                   String               @unique
  breakfastMealPlans     MealPlan[]           @relation("BreakfastMeal")
  dinnerMealPlans        MealPlan[]           @relation("DinnerMeal")
  lunchMealPlans         MealPlan[]           @relation("LunchMeal")
  ingredients            RecipeIngredient[]
  favoriteRecipes        UserFavoriteRecipe[]
}

model RecipeIngredient {
  id          String  @id @default(cuid())
  name        String
  weightGrams Int?
  quantity    Float?
  unit        String?
  recipeId    String
  recipe      Recipe  @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
}

model UserFavoriteWorkout {
  id        String   @id @default(cuid())
  userId    String
  workoutId String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  workout   Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  @@unique([userId, workoutId])
  @@index([userId])
}

model UserFavoriteRecipe {
  id        String   @id @default(cuid())
  userId    String
  recipeId  String
  createdAt DateTime @default(now())
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, recipeId])
  @@index([userId])
}

model User {
  id                 String                  @id @default(cuid())
  email              String                  @unique
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  emailVerified      DateTime?
  image              String?
  name               String?
  phone              String?
  role               ROLE                    @default(USER)
  password           String?
  lastActivityAt     DateTime?
  accounts           Account[]
  sessions           Session[]
  activities         UserActivity[]
  paidActivities     UserPaidActivity[]
  enrollments        UserCourseEnrollment[]
  userDailyPlans     UserDailyPlan[]
  favoriteRecipes    UserFavoriteRecipe[]
  favoriteWorkouts   UserFavoriteWorkout[]
  workoutCompletions UserWorkoutCompletion[]
  staffPermission    StaffPermission?
  userFreezes        UserFreeze[]
}

model StaffPermission {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  canViewPayments Boolean  @default(false)
  canEditAccess   Boolean  @default(false)
  canManageUsers  Boolean  @default(false)
  canGrantAccess  Boolean  @default(false)
  canLoginAsUser  Boolean  @default(false)
  canManageCourses  Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model UserActivity {
  id        String   @id @default(cuid())
  userId    String
  path      String?
  menu      String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model UserPaidActivity {
  id        String   @id @default(cuid())
  userId    String
  date      DateTime
  path      String?
  menu      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
}

model ContentBlock {
  id          String    @id @default(cuid())
  type        BlockType
  text        String?
  dailyPlanId String
  dailyPlan   DailyPlan @relation(fields: [dailyPlanId], references: [id], onDelete: Cascade)
}

model CourseDependency {
  id          String @id @default(cuid())
  courseId    String
  dependsOnId String
  course      Course @relation("CourseDependencies", fields: [courseId], references: [id], onDelete: Cascade)
  dependsOn   Course @relation("CourseDependents", fields: [dependsOnId], references: [id], onDelete: Cascade)

  @@unique([courseId, dependsOnId])
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  token   String   @unique
  expires DateTime
  email   String

  @@id([email, token])
}

model PasswordResetToken {
  email   String
  token   String   @unique
  expires DateTime

  @@id([email, token])
}

model CourseProduct {
  id                 String     @id @default(cuid())
  access             AccessType
  price              Int?
  accessDurationDays Int?
  courseId           String     @unique
  course             Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
}

model Payment {
  id        String       @id @default(cuid())
  userId    String
  userEmail String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  state     PaymentState
  products  Product[]
}

model UserAccess {
  id             String                @id @default(cuid())
  userId         String
  adminId        String?
  courseId       String
  contentType    CourseContentType
  reason         UserAccessReason
  setupCompleted Boolean               @default(false)
  expiresAt      DateTime?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  enrollmentId   String?
  enrollment     UserCourseEnrollment? @relation("EnrollmentUserAccess", fields: [enrollmentId], references: [id], onDelete: SetNull)
  history        UserAccessHistory[]

  @@index([userId, courseId])
}

model UserFreeze {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  start      DateTime
  end        DateTime
  createdBy  String?
  createdAt  DateTime @default(now())
  canceledAt DateTime?
  canceledBy String?

  @@index([userId, start])
  @@index([userId, end])
}

/// История изменений доступа. Action: grant/extend/close и т.д.
model UserAccessHistory {
  id           String     @id @default(cuid())
  userAccessId String
  action       String
  adminId      String?
  payload      Json?
  createdAt    DateTime   @default(now())
  userAccess   UserAccess @relation(fields: [userAccessId], references: [id], onDelete: Cascade)

  @@index([userAccessId])
}

model Product {
  id        String            @id @default(cuid())
  type      CourseContentType
  sku       String
  name      String
  price     Int
  quantity  Int
  paymentId String
  payment   Payment           @relation(fields: [paymentId], references: [id])
}
